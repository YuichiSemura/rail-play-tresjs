# レール接続システム改善の検討資料

## 検討概要

現在のレール配置は最後のレール終端にのみ接続可能。これを接続されていないレールの両サイドに配置可能にする改善を検討。

## 現在のシステム分析

### レール配置の制約

- 新しいレールは常に最後のレールの終端から配置される（`RailPlayGame.vue`:288行目 `createRail`関数）
- `rails.value`配列に順番に追加され、この**配列順序がそのまま接続順序**になっている

### 電車運行システムの依存性

- `useTrainRunner.ts`は`rails.value`の**配列順序に完全依存**している（95-103行目）
- 進行距離から順番に配列を走査して現在位置を特定
- 各車両の位置も同じ配列順序で後方距離を計算

### ループ検出の単純さ

- 最初と最後のレールの接続のみチェック（`RailPlayGame.vue`:241-260行目）
- 0.5以下の距離で接続と判定

## 提案変更による問題と解決策

### 1. 線路順序の複雑化

**問題**: 両端配置により `配列順序 ≠ 実際の接続順序` となる

**解決策**:

```typescript
// レール接続情報を管理する隣接リスト構造を追加
interface RailConnection {
  rail: Rail;
  neighbors: { start?: Rail; end?: Rail };
}

// 電車走行用に接続順序でソートされた配列を動的生成
const buildTraversalPath = (rails: Rail[]): Rail[] => {
  // DFSまたは隣接グラフから正しい順序を構築
}
```

### 2. ループ検出の高度化

**問題**: 任意の接続パターンでループを検出する必要がある

**解決策**:

```typescript
// Union-Findまたはグラフのサイクル検出アルゴリズムを実装
const detectLoop = (railConnections: RailConnection[]): boolean => {
  // DFSでサイクル検出、または素集合データ構造を使用
}
```

### 3. 重複配置リスクの増加

**問題**: より自由な配置で意図しない重複が発生しやすくなる

**解決策**:

- より厳密な幾何学的整合性チェック
- 接続可能な位置のビジュアル化強化
- 無効配置時の赤色プレビュー表示

### 4. 電車経路計算の複雑化

**問題**: 現在の単純な配列ベース計算が使用不可

**解決策**:

```typescript
// レール変更時に走行用配列を再構築
watch(rails, () => {
  traversalOrder.value = buildTraversalPath(rails.value);
}, { deep: true });

// useTrainRunner内で順序配列を使用
const stepTrain = () => {
  // traversalOrder配列を使用して電車位置を計算
}
```

## 推奨実装戦略

### 段階的アプローチ

1. **Phase 1**: 隣接情報管理システムの追加（既存機能は維持）
2. **Phase 2**: 両端配置機能の実装
3. **Phase 3**: 電車運行システムの新システム対応
4. **Phase 4**: レガシーコードの段階的削除

### データ構造の拡張

```typescript
// Rail型にオプショナルな隣接情報を追加
export type Rail = RailBase & {
  // 既存フィールド...
  adjacency?: {
    startConnectedTo?: string; // 接続先レールのID
    endConnectedTo?: string;
  };
};
```

### ユーザビリティの配慮

- 接続可能なポイントのハイライト表示
- 無効な配置への即座のフィードバック
- 「接続順序で並び替え」機能の提供

## 結論

この変更は**技術的に実現可能**だが、以下の理由で**慎重な検討が必要**：

**利点**:

- 削除・編集の自由度が大幅向上
- より直感的な線路建設が可能
- 複雑なレイアウトの構築が容易

**課題**:

- システム複雑度の大幅増加（特に電車運行システム）
- デバッグとメンテナンス性の低下
- パフォーマンスオーバーヘッド（グラフ計算）

**推奨**: まず小規模なプロトタイプで技術検証を行い、ユーザー体験の改善と開発コストのバランスを慎重に評価する。

## 関連ファイル

- `src/components/RailPlayGame.vue` - メインの配置ロジック
- `src/composables/useRailsGeometry.ts` - レール生成・幾何計算
- `src/composables/useTrainRunner.ts` - 電車運行システム
- `src/types/rail.ts` - レール型定義

---

*検討日時: 2025-09-12*
*ステータス: 検討段階（実装保留）*
