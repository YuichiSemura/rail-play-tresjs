# リファクタリングタスク

## 目的

- RailPlayGame への機能集中を解消し、関心ごと（幾何/状態/描画/UI）を分離
- 可読性・変更容易性・テスト容易性を向上
- 小さな PR を連続させ、安全に段階移行

## 前提（現状）

- Pinia を導入済み（src/main.ts）
- Storage 用ストア `useStorageStore` を追加済み（src/stores/storage.ts）
- RailPlayGame の保存/復元/有無判定/情報取得はストア経由に置換済み
- 型/ユーティリティ基盤を追加済み（src/types, src/utils）
- 幾何ロジックを composable 化済み（src/composables/useRailsGeometry.ts）
- 自動保存（debounce watch）を導入済み（stores/storage.ts → startAutoSave）
- ヘルプダイアログを子コンポーネントへ切り出し済み（components/panels/HelpDialog.vue）
- 型の統一を一部進行（Rail 型を共通型へ置換：RailPlayGame/composables/store 等）

---

## 全体方針（小さな PR の積み重ね）

- 1 PR = 1 機能/疎結合な変更のみ（〜200行程度）
- 既存の UI/挙動を変えない（置き換え後にスナックバーなどで軽く検証）
- 変更ごとに Build+Lint を通す（Lint の既存指摘は別 PR で計画的に解消）

---

## タスクと順序（決定）

### 1. 型とユーティリティの基盤追加（追加のみ・差し替えなし）【完了】

- 内容: 型/数値ユーティリティのファイルを追加
  - 追加: `src/types/common.ts`（Vec3/Quat, GameMode, CameraMode など）
  - 追加: `src/types/rail.ts`（Rail discriminated union, Pose など）
  - 追加: `src/utils/math.ts`（lerp/lerp3/wrapAngle/angleLerp/snapTo）
  - 追加: `src/utils/id.ts`（uid()）
- 受け入れ基準: 追加ファイルがビルド可能。既存コードの import はまだ変更しない
- リスク: なし（未参照）

### 2. 幾何ロジックの composable 化（最小差分）【完了】

- 内容: `useRailsGeometry.ts` を追加し、以下を移動
  - makeStraight/makeSlope/makeLeftCurve/makeRightCurve/poseFromRailEnd/segmentLength
- 差し替え: `RailPlayGame.vue` の該当関数呼び出しのみ import 先を変更（ロジック本体は削除）
- 受け入れ基準: 現行と同一の配置/回転でレールが置ける。Build+簡易動作確認
- リスク: 曲率/長さの取り扱い差異→既存定数をそのまま利用

### 3. Storage ストアの自動保存導入（watch のみ）【完了】

- 内容: rails/trees/buildings/piers 変更時に、一定間隔の debounce 自動保存
- 差し替え: RailPlayGame 内の自動保存ロジックをストア経由に統一（あれば）
- 受け入れ基準: 変更→数秒後に保存。復元で内容が一致。明示保存も従来通り
- リスク: 頻繁保存→debounce(1〜2s)を採用

### 4. ヘルプダイアログの子コンポーネント化【完了】

- 内容: `components/panels/HelpDialog.vue` を新規
- 差し替え: RailPlayGame のダイアログ部分を置換
- 受け入れ基準: レイアウト/表示が同一、開閉動作が同じ
- リスク: Vuetify の props 差異に注意

### 5. 3D シーンの切り出し（RailPlayScene.vue）

- 内容: TresCanvas 以下の 3D 構造とイベントを `components/scene/RailPlayScene.vue` へ移動
  - emit: pointermove/click, trainPose, mounted など必要最小限
- RailPlayGame は状態とイベントハンドラに専念
- 受け入れ基準: 3D の表示/クリック/ドラッグ挙動が等価。親子の props/emit が通る
- リスク: 参照している reactive の依存（rails/ghost 等）を props/emit で渡す整理が必要

### 6. ゴースト/配置回転ロジックの composable 化

- 内容: `useGhostPreview.ts` を追加（lastPointer, placementYaw, updateGhost, rotatePlacement, reset）
- 差し替え: RailPlayGame から該当の ref/関数を移動、呼び出しを差し替え
- 受け入れ基準: ゴーストの位置/回転スナップが従来通り
- リスク: キーボード操作（R/E/Q 等）と責務分離に注意

### 7. 列車走行ロジックの切り出し（useTrainRunner）

- 内容: `useTrainRunner.ts` を追加
  - 入力: rails, speed, running flag
  - 出力: carTransforms（姿勢配列）、onTick、start/stop
- 差し替え: RailPlayGame のアニメループ部分を置換
- 受け入れ基準: 直線/カーブ/スロープ上の走行が従来通り
- リスク: requestAnimationFrame の二重化に注意（単一ループ化）

### 8. カメラ制御の切り出し（useCameraController）

- 内容: `useCameraController.ts` を追加
  - モード（orbit/front）の切替・補間、先頭追従、スムージング
- 差し替え: RailPlayGame の cameraPosition/Rotation 更新ロジックを移動
- 受け入れ基準: 視点切替と追従が従来通り（揺れ/ラグが変化しない）
- リスク: 3D シーン側との同期（tick/pose）

### 9. サイドバー UI 分割（パネル群）

- 内容: `components/panels/{BuildPanel,RunPanel,CustomizePanel,DebugPanel}.vue` を新規
- 差し替え: RailPlayGame のサイドバー領域をそれぞれのパネルに切り出し
- 受け入れ基準: 表示/操作/ボタンの有効無効が従来通り
- リスク: props/emit 設計と責務分配

### 10. 型の全面適用（types への統一）

- 内容: 既存 `interface Rail` などを `src/types` の型に置換
- 受け入れ基準: ビルドエラーが出ない。Discriminated union で分岐が簡潔化
- リスク: 既存の部分的に optional な構造との整合（型の段階移行）

### 11. Lint 整備（安全な自動修正から）

- 内容: noUselessElse, Number.isNaN, optional chaining 等の安全フィックスを一括
- 受け入れ基準: 機能差分なしで Lint 減少。Build 通過
- リスク: env.d.ts の any 型は Vue 典型例のため許容 or 型修正を別サブタスクで

### 12. 幾何ユニットテスト導入（Vitest）

- 内容: devDeps に vitest を追加、`useRailsGeometry` のテスト（happy + edge）
- 受け入れ基準: `pnpm/npm run test` でグリーン。CI 追加は別途
- リスク: Node バージョン/GLSL プラグイン警告は無関係

### 13. ドキュメント更新

- 内容: README にアーキテクチャ概要、開発の流れ、主要 composable/コンポーネント一覧
- 受け入れ基準: 新規参加者が 10 分で開発開始できるレベル
- リスク: なし

---

## 各タスクのガイド（共通）

- 品質ゲート: Build, Lint（自動修正可能なものは適用）, 簡易スモーク（保存/復元/配置/走行）
- 計測: 目視＋ブラウザで 1 分以内の操作確認（保存→復元→走行）
- ロールバック容易性: 置換は小分割。削除は最後（移行完了後）

## 依存関係

- 5〜8 は 1〜2 の基盤が前提
- 9 の UI 分割は 5（シーン切り出し）が済んでいると楽
- 10 の型適用は 2/6/7/8 の導入後に一括のほうが衝突が少ない

## 次に着手するタスク（この順）

- [x] 1. 型とユーティリティの基盤追加（追加のみ）
- [x] 2. useRailsGeometry 追加＋呼び出し差し替え（最小）
- [x] 3. Storage 自動保存（watch + debounce）
- [x] 4. ヘルプダイアログの子コンポーネント化

次は以下へ進む:

- [ ] 5. 3D シーンの切り出し（RailPlayScene.vue）
- [ ] 6. ゴースト/配置回転ロジックの composable 化
- [ ] 7. 列車走行ロジックの切り出し（useTrainRunner）

以降は上記順序で進め、各 PR をレビュー・マージして段階移行します。
